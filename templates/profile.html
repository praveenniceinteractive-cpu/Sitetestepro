{% extends "base_platform.html" %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <!-- Header -->
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Profile</h1>
            <p class="text-slate-400 mt-1">Manage your account settings.</p>
        </div>
    </div>

    <!-- Quick Actions Config moved to History -->

    <!-- User Details Card -->
    <div class="glass-panel p-8 rounded-xl border border-white/5 max-w-2xl">
        <div class="flex items-start gap-6">
            <div
                class="w-20 h-20 rounded-full bg-blue-600 flex items-center justify-center text-3xl font-bold text-white shadow-lg shadow-blue-500/20">
                {{ user.username[0]|upper }}
            </div>
            <div class="space-y-4 flex-1">
                <div>
                    <label
                        class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1">Username</label>
                    <div class="text-xl font-medium text-white">{{ user.username }}</div>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1">Email
                        Address</label>
                    <div class="text-lg text-slate-300">{{ user.email }}</div>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1">Account
                        Type</label>
                    <div
                        class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-white/10 text-sm text-slate-300">
                        {% if user.parent_id %}
                        <i data-lucide="users" class="w-4 h-4 text-blue-400"></i>
                        <span>Sub-User (Viewer)</span>
                        {% else %}
                        <i data-lucide="crown" class="w-4 h-4 text-amber-400"></i>
                        <span>Admin</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if user.can_create_users %}
    <!-- Manage Sub-Users -->
    <div class="glass-panel p-8 rounded-xl border border-white/5 mt-8 max-w-4xl">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-semibold text-white">Manage Users</h2>
                <p class="text-slate-400 text-sm">View accounts you have created.</p>
            </div>
            <button onclick="openCreateUserModal()"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-lg shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                <i data-lucide="user-plus" class="w-4 h-4"></i>
                <span>Add User</span>
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-900/50 border-b border-white/5 text-xs text-slate-400 uppercase tracking-wider">
                        <th class="px-4 py-3 font-medium">Username</th>
                        <th class="px-4 py-3 font-medium">Email</th>
                        <th class="px-4 py-3 font-medium">Role</th>
                        <th class="px-4 py-3 font-medium">Created At</th>
                        <th class="px-4 py-3 font-medium text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-sm divide-y divide-white/5">
                    {% if sub_users %}
                    {% for sub in sub_users %}
                    <tr class="hover:bg-white/5 transition">
                        <td class="px-4 py-3 text-white font-medium">{{ sub.username }}</td>
                        <td class="px-4 py-3 text-slate-400">{{ sub.email }}</td>
                        <td class="px-4 py-3">
                            <span
                                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-slate-800 text-blue-400 border border-blue-500/20">
                                <i data-lucide="users" class="w-3 h-3"></i> Viewer
                            </span>
                        </td>
                        <td class="px-4 py-3 text-slate-500">{{ sub.created_at.strftime('%Y-%m-%d') if sub.created_at
                            else 'N/A' }}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="impersonateUser('{{ sub.id }}')"
                                class="p-2 bg-slate-800 text-slate-300 hover:text-white hover:bg-slate-700 rounded-lg border border-white/5 transition"
                                title="Login as {{ sub.username }}">
                                <i data-lucide="log-in" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-slate-500">
                            No users created yet.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Create User Modal -->
    <div id="createUserModal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">Create Sub-User</h3>
            <p class="text-slate-400 text-sm mb-4">Create a viewer account that can access your audit data.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Username</label>
                    <input type="text" id="newUsername" placeholder="username"
                        class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                    <input type="email" id="newEmail" placeholder="user@example.com"
                        class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                    <input type="password" id="newPassword" placeholder="********"
                        class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeCreateUserModal()"
                    class="px-4 py-2 text-gray-400 hover:text-white transition">Cancel</button>
                <button onclick="submitCreateUser()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition">Create
                    Account</button>
            </div>
        </div>
    </div>

</div>

<script>
    async function logout() {
        document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = "/login";
    }

    function exportSessionData() {
        Swal.fire({
            icon: 'info',
            title: 'Export Started',
            text: 'Your CSV download will begin shortly. (Demo)',
            background: '#0f172a',
            color: '#cbd5e1',
            confirmButtonColor: '#3b82f6'
        });
    }

    async function clearCompletedSessions() {
        Swal.fire({
            title: 'Are you sure?',
            text: "This will permanently delete ALL completed sessions.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#1e293b',
            confirmButtonText: 'Yes, clear all!',
            background: '#0f172a',
            color: '#f8fafc'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const token = getCookie('access_token');
                    const response = await fetch('/api/sessions', {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        Swal.fire({
                            icon: 'success',
                            title: 'Cleared!',
                            text: data.message || 'History cleared.',
                            background: '#0f172a',
                            color: '#f8fafc',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    } else {
                        throw new Error('Failed to clear sessions');
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to clear history.',
                        background: '#0f172a',
                        color: '#f8fafc'
                    });
                }
            }
        });
    }

    async function stopSession(sessionId) {
        Swal.fire({
            title: 'Stop Session?',
            text: "This will abort the running audit scan.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f59e0b',
            cancelButtonColor: '#1e293b',
            confirmButtonText: 'Yes, stop it',
            background: '#0f172a',
            color: '#f8fafc'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    icon: 'success',
                    title: 'Stopped',
                    text: 'Session ' + sessionId + ' has been stopped.',
                    background: '#0f172a',
                    color: '#f8fafc',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => location.reload());
            }
        });
    }

    async function deleteSession(sessionId, sessionType) {
        Swal.fire({
            title: 'Delete Session?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#1e293b',
            confirmButtonText: 'Yes, delete it',
            background: '#0f172a',
            color: '#f8fafc'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const token = getCookie('access_token');
                    const response = await fetch('/api/sessions/' + sessionId, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Your file has been deleted.',
                            background: '#0f172a',
                            color: '#f8fafc',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to delete session',
                            background: '#0f172a',
                            color: '#f8fafc'
                        });
                    }
                } catch (e) {
                    console.error(e);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred',
                        background: '#0f172a',
                        color: '#f8fafc'
                    });
                }
            }
        });
    }

    function getCookie(name) {
        const value = '; ' + document.cookie;
        const parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // Search Filter
    document.getElementById('searchSessions').addEventListener('input', function (e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.session-row').forEach(row => {
            const name = row.getAttribute('data-name');
            row.style.display = name.includes(term) ? '' : 'none';
        });
    });

    // Format Dates to Local Timezone
    function formatDates() {
        document.querySelectorAll('.session-date-cell').forEach(cell => {
            const rawTs = cell.getAttribute('data-timestamp');
            if (!rawTs) return;

            // Assume UTC as per models.py (datetime.utcnow)
            // Append Z to ensure it is treated as UTC
            const ts = rawTs.endsWith('Z') ? rawTs : rawTs + 'Z';
            const date = new Date(ts);

            // Format Date: YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            // Format Time: HH:MM (24-hour)
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const formattedTime = `${hours}:${minutes}`;

            cell.innerHTML = `${formattedDate} <div class="text-xs text-slate-600">${formattedTime}</div>`;
        });
    }

    document.addEventListener('DOMContentLoaded', formatDates);

    // Create User Modal Functions
    function openCreateUserModal() {
        const modal = document.getElementById('createUserModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeCreateUserModal() {
        const modal = document.getElementById('createUserModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        // Clear fields
        document.getElementById('newUsername').value = '';
        document.getElementById('newEmail').value = '';
        document.getElementById('newPassword').value = '';
    }

    function getCookie(name) {
        const value = '; ' + document.cookie;
        const parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    async function submitCreateUser() {
        const username = document.getElementById('newUsername').value;
        const email = document.getElementById('newEmail').value;
        const password = document.getElementById('newPassword').value;

        if (!username || !email || !password) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Fields',
                text: 'Please fill in all fields.',
                background: '#1f2937',
                color: '#fff'
            });
            return;
        }

        try {
            const token = getCookie('access_token');
            const response = await fetch('/api/sub-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ username, email, password })
            });

            const data = await response.json();

            if (response.ok) {
                closeCreateUserModal();
                Swal.fire({
                    icon: 'success',
                    title: 'User Created',
                    text: 'The sub-user account has been created successfully.',
                    background: '#1f2937',
                    color: '#fff',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => location.reload());
            } else {
                throw new Error(data.detail || 'Failed to create user');
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message,
                background: '#1f2937',
                color: '#fff'
            });
        }
    }

    async function impersonateUser(userId) {
        Swal.fire({
            title: 'Login as User?',
            text: "You are about to log in as this sub-user.",
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3b82f6',
            cancelButtonColor: '#1e293b',
            confirmButtonText: 'Yes, Login',
            background: '#1f2937',
            color: '#fff'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const token = getCookie('access_token');
                    const response = await fetch('/api/impersonate/' + userId, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Redirect to dashboard as the new user
                        window.location.href = data.redirect_url || '/platform/dashboard';
                    } else {
                        const err = await response.json();
                        throw new Error(err.detail || 'Impersonation failed');
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: e.message,
                        background: '#1f2937',
                        color: '#fff'
                    });
                }
            }
        });
    }
</script>
{% endblock %}